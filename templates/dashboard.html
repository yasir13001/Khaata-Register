<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Dashboard - Khaata</title>
  <style>
    /* base */
    body{font-family:Segoe UI,Arial, sans-serif;background:#f4f6fb;margin:0;padding:0}
    header{background:#fff;padding:12px 20px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid #eee;box-shadow:0 2px 8px rgba(0,0,0,0.03)}
    .container{display:flex;gap:12px;padding:12px}
    .left{width:260px;background:linear-gradient(180deg,#1f2937,#111827);color:#fff;padding:14px;border-radius:8px;height:calc(100vh - 80px);overflow:auto;box-shadow:0 6px 20px rgba(0,0,0,0.08)}
    .main{flex:1;background:transparent;padding:12px}
    input,select,button,textarea{font-family:inherit}
    .btn{padding:8px 12px;border:none;border-radius:8px;background:#007acc;color:#fff;cursor:pointer;transition:all .18s ease;font-weight:700} /* bold by default */
    .btn:active{transform:translateY(1px)}
    .muted{color:#666;font-size:13px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid #eee;text-align:left}
    .form-row{display:flex;gap:12px;align-items:center;margin-bottom:8px}
    /* FIX: make labels fixed width and right-aligned so inputs line up */
    .form-row label{width:100px;min-width:100px;text-align:right;padding-right:6px;font-weight:600;color:#333}
    .form-row input{flex:1;padding:8px;border-radius:6px;border:1px solid #d3dbe6}
    .form-row select{flex:1;padding:8px;border-radius:6px;border:1px solid #d3dbe6}
    .form-row textarea{flex:1;padding:8px;border-radius:6px;border:1px solid #d3dbe6;min-height:54px}
    /* button row: right aligned and separated from the rest */
    .form-row-btn{display:flex;justify-content:flex-end;margin-top:10px}
    .form-row-btn .btn{font-weight:800} /* extra bold specifically */
    /* style cards */
    .card{background:#fff;padding:14px;border-radius:10px;box-shadow:0 6px 18px rgba(15,23,42,0.06)}
    .actions-row{display:flex;gap:12px}
    .action-card{flex:1}
    /* table looks */
    thead th{background:#007acc;color:#fff;position:sticky;top:0}
    tbody tr:nth-child(even){background:#fbfcff}
    tbody tr:hover{background:#eef8ff}
    /* left list */
    #customers li{padding:8px;border-radius:6px;margin-bottom:6px;background:rgba(255,255,255,0.03);cursor:pointer}
    #customers li:hover{background:rgba(255,255,255,0.06)}

    .suggest-list {
      list-style:none;
      margin:0;
      padding:0;
      border:1px solid #ccc;
      border-radius:6px;
      max-height:120px;
      overflow-y:auto;
      position:absolute;
      background:white;
      z-index:999;
    }
    .suggest-list li {
      padding:6px;
      cursor:pointer;
    }
    .suggest-list li.highlight {
      background:#007acc;
      color:white;
    }
    .suggest-list li:hover { background:#eef; }
        /* small responsive tweak */
        @media (max-width:900px){
          .container{flex-direction:column}
          .left{width:100%;height:auto}
          .form-row label{width:110px}
        }

    /* Keep the action buttons inside table compact */
    td .btn{padding:6px 8px;border-radius:6px;font-size:13px}
    td .btn + .btn {margin-left:8px}
  </style>
</head>
<body>
  <header>
    <div><strong>ZIA COMPUTERS AND DOCUMENTATION CENTER</strong> ‚Äî Welcome {{ user }} ({{ role }})</div>
    <div>
      <button class="btn" onclick="location.href='/logout'">Logout</button>
    </div>
  </header>

  <div class="container">
    <div class="left">
      <h4 style="margin-top:0">Customers</h4>
      <input id="cust-filter" placeholder="Search customers..." style="width:95%;padding:8px;margin-bottom:8px;border-radius:6px;border:none">
      <ul id="customers" style="list-style:none;padding:0;margin:0"></ul>
      <hr style="border:none;border-top:1px solid rgba(255,255,255,0.06);margin:12px 0">
      <h4>Purchases</h4>
      <button class="btn" onclick="showPurchases()">Show Purchases</button>

      {% if role == "admin" %}
      <hr style="border:none;border-top:1px solid rgba(255,255,255,0.06);margin:12px 0">
      <h4>User Management</h4>
      <button class="btn" onclick="loadUsers()">Manage Users</button>
      <ul id="user-list" style="list-style:none;padding:0;margin:6px 0"></ul>
      <button class="btn" onclick="location.href='/register'">Register</button>
      {% endif %}

      <a href="/change_password" style="display:block;margin-top:10px;text-decoration:none">
        <button class="btn" style="background:#0ea5a5">Change Password</button>
      </a>

      {% if role == "admin" %}
      <a href="/admin/reset_password" style="text-decoration:none;display:block;margin-top:12px">
        <button style="padding:10px 18px;background:#d9534f;border:none;color:white;border-radius:8px;cursor:pointer;font-weight:700">
          üîê Reset User Password
        </button>
      </a>
      {% endif %}
    </div>

    <div class="main">
      <div class="card">
        <h3 style="margin:0 0 12px 0">Actions</h3>

        <div class="actions-row">
          <div class="action-card card">
            <h4 style="color:#007acc;margin-top:0">Add Credit</h4>
            <div class="form-row">
              <label for="credit-customer">Customer</label>
              <input id="credit-customer" placeholder="Customer name">
              <ul id="credit-suggest" class="suggest-list"></ul>
            </div>
            <div class="form-row">
              <label for="credit-amount">Amount</label>
              <input id="credit-amount" type="number" step="0.01" placeholder="0.00">
            </div>
            <div class="form-row">
              <label for="credit-desc">Desc</label>
              <input id="credit-desc" placeholder="Description">
            </div>

            <!-- RIGHT-ALIGNED BOLD BUTTON -->
            <div class="form-row-btn">
              <button class="btn" onclick="addCredit()">Add Credit</button>
            </div>
          </div>

          <div class="action-card card">
            <h4 style="color:#007acc;margin-top:0">Record Payment</h4>
            <div class="form-row">
              <label for="pay-customer">Customer</label>
              <input id="pay-customer" placeholder="Customer name">
              <ul id="pay-suggest" class="suggest-list"></ul>
            </div>
            <div class="form-row">
              <label for="pay-amount">Amount</label>
              <input id="pay-amount" type="number" step="0.01" placeholder="0.00">
            </div>
            <div class="form-row">
              <label for="pay-desc">Desc</label>
              <input id="pay-desc" placeholder="Description">
            </div>

            <div class="form-row-btn">
              <button class="btn" onclick="addPayment()">Record Payment</button>
            </div>
          </div>

          <div class="action-card card">
            <h4 style="color:#007acc;margin-top:0">Add Purchase</h4>
            <div class="form-row">
              <label for="purchase-customer">Customer</label>
              <input id="purchase-customer" placeholder="Customer name">
              <ul id="purchase-suggest" class="suggest-list"></ul>
            </div>
            <div class="form-row">
              <label for="purchase-amount">Amount</label>
              <input id="purchase-amount" type="number" step="0.01" placeholder="0.00">
            </div>
            <div class="form-row">
              <label for="purchase-items">Items</label>
              <input id="purchase-items" placeholder="Items bought">
            </div>

            <div class="form-row-btn">
              <button class="btn" onclick="addPurchase()">Add Purchase</button>
            </div>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:14px">
        <h3 style="margin:0 0 12px 0">Records</h3>

        <div style="margin-bottom:8px;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <input id="search-term" placeholder="Search customer..." style="padding:8px;border-radius:6px;border:1px solid #d3dbe6">
          <button class="btn" onclick="loadRecords()">Search</button>
          <button class="btn" onclick="loadRecords(true)">Show All</button>
          <button class="btn" onclick="downloadCSV()">Export CSV</button>
          {% if role == "admin" %}
          <button class="btn" onclick="openDailyReport()">Daily Report</button>
          <a href="/filter"><button class="btn" style="background:#0ea5a5">Filter Data</button></a>
          {% endif %}
        </div>

        <div style="overflow:auto;height:50vh;margin-top:8px" class="card">
          <table id="records-table" style="border-radius:8px;overflow:hidden">
            <thead>
              <tr>
                <th>ID</th>
                <th>Date</th>
                <th>Time</th>
                <th>Customer</th>
                <th>Description</th>
                <th>Credit</th>
                <th>Payment</th>
                <th>Balance</th>
                <th>Owner</th>
                {% if role == "admin" %}
                <th>Actions</th>
                {% endif %}
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

<script>
const role = "{{ role }}";
async function api(path, opts={}) {
  const res = await fetch(path, opts);
  if (!res.ok) {
    const t = await res.text();
    alert("Error: " + res.status + "\\n" + t);
    throw new Error(t);
  }
  // some responses might not be JSON
  const ct = res.headers.get("content-type") || "";
  if (ct.includes("application/json")) return res.json();
  return res.text();
}

async function addCredit(){
  const customer = document.getElementById("credit-customer").value.trim();
  const amount = document.getElementById("credit-amount").value;
  const description = document.getElementById("credit-desc").value;
  if(!customer || !amount){ alert("fill fields"); return; }
  await api("/api/add_credit", {method:"POST", headers:{"content-type":"application/json"}, body:JSON.stringify({customer, amount, description})});
  document.getElementById("credit-customer").value = "";
  document.getElementById("pay-customer").value = "";
  document.getElementById("purchase-customer").value = "";
  document.getElementById("credit-amount").value = "";
  document.getElementById("credit-desc").value = "";
  loadRecords(true);
}

async function addPayment(){
  const customer = document.getElementById("pay-customer").value.trim();
  const amount = document.getElementById("pay-amount").value;
  const description = document.getElementById("pay-desc").value;
  if(!customer || !amount){ alert("fill fields"); return; }
  await api("/api/add_payment", {method:"POST", headers:{"content-type":"application/json"}, body:JSON.stringify({customer, amount, description})});
  document.getElementById("credit-customer").value = "";
  document.getElementById("purchase-customer").value = "";
  document.getElementById("pay-customer").value = "";
  document.getElementById("pay-amount").value = "";
  document.getElementById("pay-desc").value = "";
  loadRecords(true);
}

async function addPurchase(){
  const customer = document.getElementById("purchase-customer").value.trim();
  const items = document.getElementById("purchase-items").value.trim();
  const amount = document.getElementById("purchase-amount").value;
  if(!customer || !items || !amount){ alert("fill fields"); return; }
  await api("/api/add_purchase", {method:"POST", headers:{"content-type":"application/json"}, body:JSON.stringify({customer, items, amount})});
  document.getElementById("purchase-customer").value = "";
  document.getElementById("credit-customer").value = "";
  document.getElementById("purchase-items").value = "";
  document.getElementById("purchase-amount").value = "";
}

function openDailyReport() {
    window.location.href = "/daily-report";
}

function showPurchases() {
    const { protocol, host } = window.location;
    const url = `${protocol}//${host}/purchases`;
    window.open(url, "_blank");
}

function clearRecordsTable() {
    const tbody = document.querySelector("#records-table tbody");
    if (tbody) tbody.innerHTML = "";
}

function makeRowEditable(tr) {
  const cells = tr.querySelectorAll("td[data-field]");
  cells.forEach(td => {
    const field = td.dataset.field;
    if (["ID","Date","Time","Balance","Owner"].includes(field)) return;
    const input = document.createElement("input");
    input.value = td.textContent;
    input.style.width = "100%";
    td.textContent = "";
    td.appendChild(input);
  });

  const actionTd = tr.querySelector("td:last-child");
  actionTd.innerHTML = "";
  const saveBtn = document.createElement("button");
  saveBtn.textContent = "Save";
  saveBtn.className = "btn";
  saveBtn.onclick = () => saveRecord(tr);
  const cancelBtn = document.createElement("button");
  cancelBtn.textContent = "Cancel";
  cancelBtn.className = "btn";
  cancelBtn.onclick = () => loadRecords(true);
  actionTd.appendChild(saveBtn);
  actionTd.appendChild(cancelBtn);
}

async function filterRecords(customer){
    const data = await api("/api/credits");
    const rows = data.records.filter(r => r.Customer === customer);
    const tbody = document.querySelector("#records-table tbody");
    tbody.innerHTML = "";
    const isAdmin = "{{ role }}" === "admin";
    rows.forEach(r => {
        const tr = document.createElement("tr");
        ["ID","Date","Time","Customer","Description","Credit","Payment","Balance","Owner"].forEach(k=>{
            const td = document.createElement("td");
            td.textContent = r[k] ?? "";
            td.dataset.field = k;
            td.dataset.id = r.ID;
            tr.appendChild(td);
        });
        if (isAdmin) {
            const actionTd = document.createElement("td");
            const editBtn = document.createElement("button");
            editBtn.textContent = "Edit";
            editBtn.className = "btn";
            editBtn.onclick = () => makeRowEditable(tr);
            const deleteBtn = document.createElement("button");
            deleteBtn.textContent = "Delete";
            deleteBtn.className = "btn";
            deleteBtn.onclick = () => deleteRecord(r.ID);
            actionTd.appendChild(editBtn);
            actionTd.appendChild(deleteBtn);
            tr.appendChild(actionTd);
        }
        tbody.appendChild(tr);
    });
}

async function editRecord(id){
  const newDesc = prompt("Enter new description:");
  if(newDesc === null) return;
  await api("/api/edit_record/" + id, {
    method: "PUT",
    headers: { "content-type": "application/json" },
    body: JSON.stringify({ Description: newDesc })
  });
  loadRecords(true);
}

async function loadRecords(showAll=false) {
  const term = document.getElementById("search-term").value.trim();
  const data = await api("/api/credits");
  let rows = data.records || [];
  if (!showAll && term) {
    rows = rows.filter(r => r.Customer && r.Customer.toLowerCase().includes(term.toLowerCase()));
  }

  const tbody = document.querySelector("#records-table tbody");
  tbody.innerHTML = "";

  rows.forEach(r => {
    const tr = document.createElement("tr");
    ["ID","Date","Time","Customer","Description","Credit","Payment","Balance","Owner"].forEach(k=>{
      const td = document.createElement("td");
      td.textContent = r[k] ?? "";
      td.dataset.field = k;
      td.dataset.id = r.ID;
      tr.appendChild(td);
    });

    const actionTd = document.createElement("td");
    const editBtn = document.createElement("button");
    editBtn.textContent = "Edit";
    editBtn.className = "btn";
    editBtn.onclick = () => makeRowEditable(tr);
    const deleteBtn = document.createElement("button");
    deleteBtn.textContent = "Delete";
    deleteBtn.className = "btn";
    deleteBtn.onclick = () => deleteRecord(r.ID);
    actionTd.appendChild(editBtn);
    actionTd.appendChild(deleteBtn);
    tr.appendChild(actionTd);

    tbody.appendChild(tr);
  });
}
async function saveRecord(tr) {
  const id = tr.querySelector("td[data-field='ID']").textContent;
  const updated = {};
  tr.querySelectorAll("td[data-field]").forEach(td => {
    const input = td.querySelector("input");
    if (input) updated[td.dataset.field] = input.value;
  });
  if (Object.keys(updated).length === 0) return;
  await api(`/api/edit_credit/${id}`, {
    method: "POST",
    headers: {"content-type": "application/json"},
    body: JSON.stringify(updated)
  });
  loadRecords(true);
}

async function filterCustomerList() {
    const term = document.getElementById("cust-filter").value.trim().toLowerCase();
    const ul = document.getElementById("customers");
    ul.innerHTML = "";
    if (!term) return;
    const data = await api("/api/customers");
    const matched = (data.customers || []).filter(c => c.toLowerCase().includes(term));
    matched.forEach(c => {
        const li = document.createElement("li");
        li.style.padding = "6px";
        li.style.cursor = "pointer";
        li.textContent = c;
        li.onclick = () => {
            document.getElementById("credit-customer").value = c;
            document.getElementById("pay-customer").value = c;
            document.getElementById("purchase-customer").value = c;
            filterRecords(c);
            ul.innerHTML = "";
        };
        ul.appendChild(li);
    });
}

async function onTypingCustomer(e) {
    let typed = e.target.value.trim().toLowerCase();
    if (!typed) return;
    const data = await api("/api/customers");
    const customers = (data.customers || []).map(c => c.toLowerCase());
    if (!customers.includes(typed)) {
        clearRecordsTable();
    }
}

async function deleteRecord(id) {
  if (!confirm("Delete this record?")) return;
  await api(`/api/delete_record/${id}`, { method: "DELETE" });
  loadRecords(true);
}
async function downloadCSV(){
  const res = await fetch("/api/download/credits");
  if(!res.ok){ alert("download failed"); return; }
  const txt = await res.text();
  const blob = new Blob([txt], {type:"text/csv"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = "credits_export.csv"; a.click();
  URL.revokeObjectURL(url);
}

async function loadUsers() {
    const ul = document.getElementById("user-list");
    if (ul.innerHTML.trim() !== "") {
        ul.innerHTML = "";
        return;
    }
    const res = await fetch("/api/users", { credentials: "include" });
    if (!res.ok) {
        const text = await res.text();
        alert("Error loading users: " + res.status + "\\n" + text);
        return;
    }
    const data = await res.json();
    ul.innerHTML = "";
    data.users.forEach(u => {
        const li = document.createElement("li");
        li.style.padding = "6px";
        li.innerHTML = `
            ${u.username} (${u.role})
            <button onclick="deleteUser('${u.username}')" style="background:#d9534f;color:white;margin-left:10px;border:none;padding:6px 8px;border-radius:6px;cursor:pointer">Delete</button>
        `;
        ul.appendChild(li);
    });
}

async function deleteUser(username) {
    if (!confirm("Delete user '" + username + "'?")) return;
    let res = await fetch("/api/delete_user/" + username, { method: "DELETE", credentials: "include" });
    let data = await res.json();
    if (!res.ok) {
        alert("Error: " + (data.detail || data.message || "Unknown error"));
        return;
    }
    alert(data.message);
    loadUsers();
}

const suggestionInputs = [
  { inputId: "credit-customer", suggestId: "credit-suggest" },
  { inputId: "pay-customer", suggestId: "pay-suggest" },
  { inputId: "purchase-customer", suggestId: "purchase-suggest" }
];

// Store selected indices per input
const selectedIndices = {};

async function showCustomerSuggestions(inputId, suggestId) {
    const input = document.getElementById(inputId);
    const ul = document.getElementById(suggestId);
    ul.innerHTML = "";
    selectedIndices[inputId] = -1;

    const term = input.value.trim().toLowerCase();
    if (!term) return;

    const data = await api("/api/customers");
    const matched = (data.customers || []).filter(c => c.toLowerCase().includes(term));

    matched.forEach((c, index) => {
        const li = document.createElement("li");
        li.textContent = c;
        li.onclick = () => {
            input.value = c;
            ul.innerHTML = "";
            filterRecords(c);
        };
        ul.appendChild(li);
    });
}

// Handle arrow keys for a specific input
function handleArrowKeys(inputId, suggestId, event) {
    const ul = document.getElementById(suggestId);
    const items = ul.querySelectorAll("li");
    if (!items.length) return;

    if (selectedIndices[inputId] === undefined) selectedIndices[inputId] = -1;

    if (event.key === "ArrowDown") {
        selectedIndices[inputId] = (selectedIndices[inputId] + 1) % items.length;
        updateHighlight(items, inputId);
        event.preventDefault();
    } else if (event.key === "ArrowUp") {
        selectedIndices[inputId] = (selectedIndices[inputId] - 1 + items.length) % items.length;
        updateHighlight(items, inputId);
        event.preventDefault();
    } else if (event.key === "Enter") {
        if (selectedIndices[inputId] >= 0 && selectedIndices[inputId] < items.length) {
            document.getElementById(inputId).value = items[selectedIndices[inputId]].textContent;
            ul.innerHTML = "";
            filterRecords(document.getElementById(inputId).value);
        }
        event.preventDefault();
    }
}

function updateHighlight(items, inputId) {
    const idx = selectedIndices[inputId];
    items.forEach((li, i) => li.classList.toggle("highlight", i === idx));
}

// Close suggestions if click outside
document.addEventListener("click", (e) => {
    suggestionInputs.forEach(f => {
        const ul = document.getElementById(f.suggestId);
        const input = document.getElementById(f.inputId);
        if (!input.contains(e.target) && !ul.contains(e.target)) {
            ul.innerHTML = "";
        }
    });
});

// Attach events
suggestionInputs.forEach(f => {
    const input = document.getElementById(f.inputId);
    input.parentElement.style.position = "relative"; // ensure absolute works
    input.addEventListener("input", () => showCustomerSuggestions(f.inputId, f.suggestId));
    input.addEventListener("keydown", (e) => handleArrowKeys(f.inputId, f.suggestId, e));
    input.addEventListener("input", onTypingCustomer);
});

document.getElementById("credit-customer").addEventListener("input", onTypingCustomer);
document.getElementById("pay-customer").addEventListener("input", onTypingCustomer);
document.getElementById("purchase-customer").addEventListener("input", onTypingCustomer);
document.getElementById("cust-filter").addEventListener("input", filterCustomerList);

window.addEventListener("load", ()=>{ loadRecords(true); });
</script>

</body>
</html>
