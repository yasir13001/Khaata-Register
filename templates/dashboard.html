<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Dashboard - Khaata</title>
  <style>
    body{font-family:Segoe UI,Arial;background:#f4f6fb;margin:0;padding:0}
    header{background:#fff;padding:12px 20px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid #eee}
    .container{display:flex;gap:12px;padding:12px}
    .left{width:240px;background:#fff;padding:10px;border-radius:6px;height:calc(100vh - 80px);overflow:auto}
    .main{flex:1;background:#fff;padding:12px;border-radius:6px;height:calc(100vh - 80px);overflow:auto}
    input,select,button,textarea{font-family:inherit}
    .btn{padding:8px 10px;border:none;border-radius:6px;background:#007acc;color:#fff;cursor:pointer}
    .muted{color:#666;font-size:13px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:6px;border-bottom:1px solid #eee;text-align:left}
    .form-row{display:flex;gap:8px;align-items:center;margin-bottom:8px}
    label{min-width:80px}
  </style>
</head>
<body>
  <header>
    <div><strong>Khaata</strong> — Welcome {{ user }} ({{ role }})</div>
    <div>
      <button onclick="location.href='/logout'">Logout</button>
      <button onclick="location.href='/register'">Register</button>
    </div>
  </header>

  <div class="container">
    <div class="left">
      <h4>Customers</h4>
      <input id="cust-filter" placeholder="Search customers..." style="width:80%;padding:6px;margin-bottom:8px">
      <ul id="customers" style="list-style:none;padding:0;margin:0"></ul>
      <hr>
      <h4>Purchases</h4>
      <button class="btn" onclick="showPurchases()">Show Purchases</button>
    </div>

    <div class="main">
      <h3>Actions</h3>

      <div style="display:flex;gap:12px">
        <div style="flex:1">
          <h4>Add Credit</h4>
          <div class="form-row"><label>Customer</label><input id="credit-customer"></div>
          <div class="form-row"><label>Amount</label><input id="credit-amount" type="number" step="0.01"></div>
          <div class="form-row"><label>Desc</label><input id="credit-desc"></div>
          <button class="btn" onclick="addCredit()">Add Credit</button>
        </div>

        <div style="flex:1">
          <h4>Record Payment</h4>
          <div class="form-row"><label>Customer</label><input id="pay-customer"></div>
          <div class="form-row"><label>Amount</label><input id="pay-amount" type="number" step="0.01"></div>
          <div class="form-row"><label>Desc</label><input id="pay-desc"></div>
          <button class="btn" onclick="addPayment()">Record Payment</button>
        </div>

        <div style="flex:1">
          <h4>Add Purchase</h4>
          <div class="form-row"><label>Customer</label><input id="purchase-customer"></div>
          <div class="form-row"><label>Amount</label><input id="purchase-amount" type="number" step="0.01"></div>
          <div class="form-row"><label>Items</label><input id="purchase-items"></div>
          
          <button class="btn" onclick="addPurchase()">Add Purchase</button>
        </div>
      </div>

      <hr>
      <h3>Records</h3>
      <div style="margin-bottom:8px">
        <input id="search-term" placeholder="Search customer..." style="padding:6px">
        <button class="btn" onclick="loadRecords()">Search</button>
        <button class="btn" onclick="loadRecords(true)">Show All</button>
        <button class="btn" onclick="downloadCSV()">Export CSV</button>
      </div>

      <div style="overflow:auto;height:50vh">
        <table id="records-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Date</th>
              <th>Time</th>
              <th>Customer</th>
              <th>Description</th>
              <th>Credit</th>
              <th>Payment</th>
              <th>Balance</th>
              <th>Owner</th>
              {% if role == "admin" %}
              <th>Actions</th>  <!-- <- put it here, inside the header row -->
              {% endif %}
            </tr>
          </thead>

          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

<script>
const role = "{{ role }}";
async function api(path, opts={}) {
  const res = await fetch(path, opts);
  if (!res.ok) {
    const t = await res.text();
    alert("Error: " + res.status + "\\n" + t);
    throw new Error(t);
  }
  return res.json?.() ?? res;
}

async function refreshCustomers() {
  const data = await api("/api/customers");
  const ul = document.getElementById("customers");
  ul.innerHTML = "";
  data.customers.forEach(c => {
    const li = document.createElement("li");
    li.style.padding = "6px";
    li.style.cursor = "pointer";
    li.textContent = c;
    li.onclick = () => {
      document.getElementById("credit-customer").value = c;
      document.getElementById("pay-customer").value = c;
      document.getElementById("purchase-customer").value = c;
      filterRecords(c);
    };
    ul.appendChild(li);
  });
}

async function loadRecords(showAll=false) {
  const term = document.getElementById("search-term").value.trim();
  const data = await api("/api/credits");
  let rows = data.records;
  
  if (!showAll && term) {
    rows = rows.filter(r => r.Customer && r.Customer.toLowerCase().includes(term.toLowerCase()));
  }
  
  const tbody = document.querySelector("#records-table tbody");
  tbody.innerHTML = "";

  // assuming role is defined globally, e.g., const role = "{{ role }}";
  const isAdmin = role === "admin";

  rows.forEach(r => {
    const tr = document.createElement("tr");

    ["ID","Date","Time","Customer","Description","Credit","Payment","Balance","Owner"].forEach(k => {
      const td = document.createElement("td");
      td.textContent = r[k] ?? "";
      tr.appendChild(td);
    });

    if (isAdmin) {
      const tdActions = document.createElement("td");

      const btnEdit = document.createElement("button");
      btnEdit.textContent = "Edit";
      btnEdit.className = "btn";
      btnEdit.style.marginRight = "4px";
      btnEdit.onclick = () => editRecord(r.ID);

      const btnDelete = document.createElement("button");
      btnDelete.textContent = "Delete";
      btnDelete.className = "btn";
      btnDelete.onclick = () => deleteRecord(r.ID);

      tdActions.appendChild(btnEdit);
      tdActions.appendChild(btnDelete);
      tr.appendChild(tdActions);
    }

    tbody.appendChild(tr);
  });
}


async function addCredit(){
  const customer = document.getElementById("credit-customer").value.trim();
  const amount = document.getElementById("credit-amount").value;
  const description = document.getElementById("credit-desc").value;
  if(!customer || !amount){ alert("fill fields"); return; }
  await api("/api/add_credit", {method:"POST", headers:{"content-type":"application/json"}, body:JSON.stringify({customer, amount, description})});
  // alert("Credit added");
    // CLEAR FIELDS
  document.getElementById("credit-customer").value = "";
  document.getElementById("pay-customer").value = "";
  document.getElementById("purchase-customer").value = "";

  document.getElementById("credit-amount").value = "";
  document.getElementById("credit-desc").value = "";

  refreshCustomers(); loadRecords(true);
}

async function addPayment(){
  const customer = document.getElementById("pay-customer").value.trim();
  const amount = document.getElementById("pay-amount").value;
  const description = document.getElementById("pay-desc").value;
  if(!customer || !amount){ alert("fill fields"); return; }
  await api("/api/add_payment", {method:"POST", headers:{"content-type":"application/json"}, body:JSON.stringify({customer, amount, description})});
  // alert("Payment recorded");
  // CLEAR FIELDS
  document.getElementById("credit-customer").value = "";
  document.getElementById("purchase-customer").value = "";
  document.getElementById("pay-customer").value = "";
  document.getElementById("pay-amount").value = "";
  document.getElementById("pay-desc").value = "";

  refreshCustomers(); loadRecords(true);
}

async function addPurchase(){
  const customer = document.getElementById("purchase-customer").value.trim();
  const items = document.getElementById("purchase-items").value.trim();
  const amount = document.getElementById("purchase-amount").value;
  if(!customer || !items || !amount){ alert("fill fields"); return; }
  await api("/api/add_purchase", {method:"POST", headers:{"content-type":"application/json"}, body:JSON.stringify({customer, items, amount})});
  // alert("Purchase added");

  // CLEAR FIELDS
  document.getElementById("purchase-customer").value = "";
  document.getElementById("credit-customer").value = "";
  document.getElementById("purchase-customer").value = "";
  document.getElementById("purchase-items").value = "";
  document.getElementById("purchase-amount").value = "";

}
async function filterCustomerList() {
    const term = document.getElementById("cust-filter").value.trim().toLowerCase();
    const data = await api("/api/customers");
    const ul = document.getElementById("customers");
    ul.innerHTML = "";

    data.customers
        .filter(c => c.toLowerCase().includes(term))
        .forEach(c => {
            const li = document.createElement("li");
            li.style.padding = "6px";
            li.style.cursor = "pointer";
            li.textContent = c;
            li.onclick = () => {
                document.getElementById("credit-customer").value = c;
                document.getElementById("pay-customer").value = c;
                document.getElementById("purchase-customer").value = c;
                filterRecords(c);
            };
            ul.appendChild(li);
        });
}


function showPurchases() {
    window.open("http://192.168.192.1:8000/purchases", "_blank");
}
function clearRecordsTable() {
    const tbody = document.querySelector("#records-table tbody");
    if (tbody) tbody.innerHTML = "";
}

function makeRowEditable(tr) {
  const cells = tr.querySelectorAll("td[data-field]");
  cells.forEach(td => {
    const field = td.dataset.field;
    if (["ID","Date","Time","Balance","Owner"].includes(field)) return; // skip read-only fields

    const input = document.createElement("input");
    input.value = td.textContent;
    input.style.width = "100%";
    td.textContent = "";
    td.appendChild(input);
  });

  // Replace Edit button with Save & Cancel
  const actionTd = tr.querySelector("td:last-child");
  actionTd.innerHTML = "";

  const saveBtn = document.createElement("button");
  saveBtn.textContent = "Save";
  saveBtn.className = "btn";
  saveBtn.onclick = () => saveRecord(tr);

  const cancelBtn = document.createElement("button");
  cancelBtn.textContent = "Cancel";
  cancelBtn.className = "btn";
  cancelBtn.onclick = () => loadRecords(true); // reload to cancel edit

  actionTd.appendChild(saveBtn);
  actionTd.appendChild(cancelBtn);
}

async function filterRecords(customer){
  const data = await api("/api/credits");
  const rows = data.records.filter(r => r.Customer === customer);
  const tbody = document.querySelector("#records-table tbody");
  tbody.innerHTML = "";
  rows.forEach(r => {
    const tr = document.createElement("tr");
    ["ID","Date","Time","Customer","Description","Credit","Payment","Balance","Owner"].forEach(k=>{
      const td = document.createElement("td");
      td.textContent = r[k] ?? "";
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });
}

async function editRecord(id){
  const newDesc = prompt("Enter new description:");
  if(newDesc === null) return;  // user canceled
  await api("/api/edit_record/" + id, {
    method: "PUT",
    headers: { "content-type": "application/json" },
    body: JSON.stringify({ Description: newDesc })
  });
  loadRecords(true);
}

async function loadRecords(showAll=false) {
  const term = document.getElementById("search-term").value.trim();
  const data = await api("/api/credits");
  let rows = data.records;
  if (!showAll && term) {
    rows = rows.filter(r => r.Customer && r.Customer.toLowerCase().includes(term.toLowerCase()));
  }

  const tbody = document.querySelector("#records-table tbody");
  tbody.innerHTML = "";

  rows.forEach(r => {
    const tr = document.createElement("tr");
    ["ID","Date","Time","Customer","Description","Credit","Payment","Balance","Owner"].forEach(k=>{
      const td = document.createElement("td");
      td.textContent = r[k] ?? "";
      td.dataset.field = k;          // store field name for editing
      td.dataset.id = r.ID;           // store record ID
      tr.appendChild(td);
    });

    // Actions column
    const actionTd = document.createElement("td");

    const editBtn = document.createElement("button");
    editBtn.textContent = "Edit";
    editBtn.className = "btn";
    editBtn.onclick = () => makeRowEditable(tr);

    const deleteBtn = document.createElement("button");
    deleteBtn.textContent = "Delete";
    deleteBtn.className = "btn";
    deleteBtn.onclick = () => deleteRecord(r.ID);

    actionTd.appendChild(editBtn);
    actionTd.appendChild(deleteBtn);
    tr.appendChild(actionTd);

    tbody.appendChild(tr);
  });
}
async function saveRecord(tr) {
  const id = tr.querySelector("td[data-field='ID']").textContent;
  const updated = {};
  
  tr.querySelectorAll("td[data-field]").forEach(td => {
    const input = td.querySelector("input");
    if (input) updated[td.dataset.field] = input.value;
  });

  if (Object.keys(updated).length === 0) return;

  await api(`/api/edit_credit/${id}`, {
    method: "POST",
    headers: {"content-type": "application/json"},
    body: JSON.stringify(updated)
  });

  loadRecords(true); // reload table after save
}

async function onTypingCustomer(e) {
    let typed = e.target.value.trim().toLowerCase();
    if (!typed) return;

    // Get customer list from backend
    const data = await api("/api/customers");
    const customers = data.customers.map(c => c.toLowerCase());

    // If new customer typed → clear table
    if (!customers.includes(typed)) {
        clearRecordsTable();
    }
}

async function deleteRecord(id) {
  if (!confirm("Delete this record?")) return;
  await api(`/api/delete_record/${id}`, { method: "DELETE" });
  loadRecords(true);
}
async function downloadCSV(){
  const res = await fetch("/api/download/credits");
  if(!res.ok){ alert("download failed"); return; }
  const txt = await res.text();
  const blob = new Blob([txt], {type:"text/csv"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = "credits_export.csv"; a.click();
  URL.revokeObjectURL(url);
}
document.getElementById("credit-customer").addEventListener("input", onTypingCustomer);
document.getElementById("pay-customer").addEventListener("input", onTypingCustomer);
document.getElementById("purchase-customer").addEventListener("input", onTypingCustomer);
document.getElementById("cust-filter").addEventListener("input", filterCustomerList);

window.addEventListener("load", ()=>{ refreshCustomers(); loadRecords(true); });
</script>

</body>
</html>
