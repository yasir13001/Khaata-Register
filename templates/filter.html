<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Filter Data</title>
    <style>
        body { font-family: Segoe UI, sans-serif; background:#f6f7fb; padding:20px; }
        .card { background:#fff; padding:20px; border-radius:10px; box-shadow:0 4px 15px rgba(0,0,0,.07); max-width:800px; margin:auto; }
        input, select { padding:8px; width:100%; margin-bottom:10px; border:1px solid #ccc; border-radius:6px; }
        button { padding:10px 14px; background:#0078d4; color:#fff; border:none; border-radius:6px; cursor:pointer; }
        table { width:100%; border-collapse:collapse; margin-top:20px; }
        td, th { padding:8px; border-bottom:1px solid #ddd; }
    </style>
</head>
<body>

<div class="card">
    <h2>Filter Transactions</h2>

    <form id="filterForm">
        <label>Customer Name</label>
        <input type="text" name="customer">

        <label>Date From</label>
        <input type="date" name="date_from">

        <label>Date To</label>
        <input type="date" name="date_to">

        <label>Balance Minimum</label>
        <input type="number" name="balance_min">

        <label>Balance Maximum</label>
        <input type="number" name="balance_max">

        <label>Owner</label>
        <input type="text" name="owner">

        <div style="display:flex; gap:10px; margin-top:10px;">
            <button type="button" onclick="applyFilters()">Apply Filters</button>
            <button type="button" onclick="downloadPDF()">Generate Invoice</button>
        </div>
    </form>


    <table id="resultsTable">
        <thead>
            <tr>
                <th>Date</th>
                <th>Customer</th>
                <th>Credit</th>
                <th>Payment</th>
                <th>Balance</th>
                <th>Owner</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<script>
async function applyFilters() {
    const form = document.getElementById("filterForm");
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());

    const response = await fetch("/api/filter", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
    });

    const result = await response.json();
    const tbody = document.querySelector("#resultsTable tbody");
    tbody.innerHTML = "";

    result.results.forEach(row => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${row.date}</td>
            <td>${row.customer}</td>
            <td>${row.credit}</td>
            <td>${row.payment}</td>
            <td>${row.balance}</td>
            <td>${row.owner}</td>
        `;
        tbody.appendChild(tr);
    });
}

async function downloadPDF() {
    const form = document.getElementById("filterForm");
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());

    try {
        const res = await fetch("/api/filter/pdf", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data)
        });

        if (!res.ok) {
            const text = await res.text();
            throw new Error(text);
        }

        const blob = await res.blob();
        const url = window.URL.createObjectURL(blob);

        // Extract filename from Content-Disposition header
        const disposition = res.headers.get("Content-Disposition");
        let filename = "invoice.pdf"; // default
        if (disposition && disposition.includes("filename=")) {
            filename = disposition.split("filename=")[1].replace(/"/g, "");
        }

        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        a.click();
        window.URL.revokeObjectURL(url);

    } catch (err) {
        alert("Failed to download PDF: " + err);
    }
}


</script>

</body>
</html>
