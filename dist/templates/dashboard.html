<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Dashboard - Khaata</title>
  <style>
body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: #f0f2f5;
  margin: 0;
  padding: 0;
  color: #333;
}

/* Header */
header {
  background: #fff;
  padding: 15px 25px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-bottom: 1px solid #ddd;
  box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

header strong {
  font-size: 1.5em;
  letter-spacing: 1px;
}

/* Buttons */
.btn {
  padding: 10px 16px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.3s ease;
  font-weight: 600;
}

.btn-primary {
  background: linear-gradient(135deg, #007acc, #00c6ff);
  color: white;
}
.btn-primary:hover {
  transform: scale(1.05);
  box-shadow: 0 5px 15px rgba(0,0,0,0.2);
}

.btn-danger {
  background: #d9534f;
  color: white;
}
.btn-danger:hover {
  transform: scale(1.05);
}

/* Layout */
.container {
  display: flex;
  gap: 15px;
  padding: 15px;
}

.left {
  width: 250px;
  background: #1e1e2f;
  color: #fff;
  padding: 15px;
  border-radius: 12px;
  height: calc(100vh - 80px);
  overflow-y: auto;
  box-shadow: 0 4px 20px rgba(0,0,0,0.2);
}

.left h4 {
  margin-top: 0;
  font-size: 1.2em;
  margin-bottom: 10px;
}

.left input {
  width: 100%;
  padding: 8px;
  border-radius: 6px;
  border: none;
  margin-bottom: 10px;
}

/* Main content */
.main {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 15px;
}

/* Card style for actions */
.action-card {
  background: #fff;
  padding: 15px;
  border-radius: 12px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.05);
  transition: all 0.3s ease;
}
.action-card:hover {
  transform: translateY(-3px);
  box-shadow: 0 8px 25px rgba(0,0,0,0.1);
}

.action-card h4 {
  margin-bottom: 10px;
  color: #007acc;
}

/* Forms inside cards */
.form-row {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 8px;
}

.form-row label {
  width: 100px;     /* FIXED WIDTH FOR ALL LABELS */
  font-weight: 600;  /* Optional: makes it cleaner */
}

.form-row input {
  flex: 1;           /* Fills remaining space */
  padding: 8px;
  border: 1px solid #ccc;
  border-radius: 6px;
}

.form-row input:focus {
  border-color: #007acc;
  box-shadow: 0 0 5px rgba(0,122,204,0.4);
}

/* Table */
table {
  width: 100%;
  border-collapse: collapse;
  border-radius: 10px;
  overflow: hidden;
  box-shadow: 0 4px 20px rgba(0,0,0,0.05);
}

th, td {
  padding: 10px;
  text-align: left;
}

th {
  background: #007acc;
  color: #fff;
  position: sticky;
  top: 0;
}

tbody tr:nth-child(even) {
  background: #f9f9f9;
}

tbody tr:hover {
  background: #e6f7ff;
}

/* Search and filter */
#search-term {
  padding: 8px;
  border-radius: 6px;
  border: 1px solid #ccc;
  margin-right: 8px;
}

</style>
</head>
<body>
  <header>
    <div><strong>Zia Computers and Documentation Center</strong> ‚Äî Welcome {{ user }} ({{ role }})</div>
    <div>
      <button class = "btn" onclick="location.href='/logout'">Logout</button>
      
    </div>
  </header>

  <div class="container">
    <div class="left">
      <h4>Customers</h4>
      <input id="cust-filter" placeholder="Search customers..." style="width:80%;padding:6px;margin-bottom:8px">
      <ul id="customers" style="list-style:none;padding:0;margin:0"></ul>
      <hr>
      <h4>Purchases</h4>
      <button class="btn" onclick="showPurchases()">Show Purchases</button>
      {% if role == "admin" %}
      <hr>
      <h4>User Management</h4>
      <button class="btn" onclick="loadUsers()">Manage Users</button>
      <ul id="user-list" style="list-style:none;padding:0;margin:2"></ul>
      <button class= "btn" onclick="location.href='/register'">Register</button>
      {% endif %}
      <a href="/change_password">
      <button style="margin:10px 0 0 0px;padding:8px 10px;border:none;background:#007acc;color:white;border-radius:6px;cursor:pointer;">
          Change Password
      </button>
      </a>
      {% if role == "admin" %}
      <a href="/admin/reset_password" style="text-decoration:none;">
        <button style="
            margin-top: 12px;
            padding: 10px 18px;
            background: #d9534f;
            border: none;
            color: white;
            border-radius: 6px;
            cursor: pointer;
        ">
          üîê Reset User Password
        </button>
      </a>
      {% endif %}

    </div>

    <div class="main">
      <h3>Actions</h3>

      <div style="display:flex;gap:12px">
        <div style="flex:1">
          <h4>Add Credit</h4>
          <div class="form-row"><label>Customer</label><input id="credit-customer"></div>
          <div class="form-row"><label>Amount</label><input id="credit-amount" type="number" step="0.01"></div>
          <div class="form-row"><label>Desc</label><input id="credit-desc"></div>
          <button class="btn" onclick="addCredit()">Add Credit</button>
        </div>

        <div style="flex:1">
          <h4>Record Payment</h4>
          <div class="form-row"><label>Customer</label><input id="pay-customer"></div>
          <div class="form-row"><label>Amount</label><input id="pay-amount" type="number" step="0.01"></div>
          <div class="form-row"><label>Desc</label><input id="pay-desc"></div>
          <button class="btn" onclick="addPayment()">Record Payment</button>
        </div>

        <div style="flex:1">
          <h4>Add Purchase</h4>
          <div class="form-row"><label>Customer</label><input id="purchase-customer"></div>
          <div class="form-row"><label>Amount</label><input id="purchase-amount" type="number" step="0.01"></div>
          <div class="form-row"><label>Items</label><input id="purchase-items"></div>
          <button class="btn" onclick="addPurchase()">Add Purchase</button>
        </div>
      </div>

      <hr>
      <h3>Records</h3>
      <div style="margin-bottom:8px">
        <input id="search-term" placeholder="Search customer..." style="padding:6px">
        <button class="btn" onclick="loadRecords()">Search</button>
        <button class="btn" onclick="loadRecords(true)">Show All</button>
        <button class="btn" onclick="downloadCSV()">Export CSV</button>
        {% if role == "admin" %}
        <button class="btn" onclick="openDailyReport()">Daily Report</button>
        {% endif %}
        {% if role == "admin" %}
        <a href="/filter">
          <button class = "btn">Filter Data</button>
        </a>
        {% endif %}
      </div>
      <div style="overflow:auto;height:50vh">
        <table id="records-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Date</th>
              <th>Time</th>
              <th>Customer</th>
              <th>Description</th>
              <th>Credit</th>
              <th>Payment</th>
              <th>Balance</th>
              <th>Owner</th>
              {% if role == "admin" %}
              <th>Actions</th>  <!-- <- put it here, inside the header row -->
              {% endif %}
            </tr>
          </thead>

          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

<script>
const role = "{{ role }}";
async function api(path, opts={}) {
  const res = await fetch(path, opts);
  if (!res.ok) {
    const t = await res.text();
    alert("Error: " + res.status + "\\n" + t);
    throw new Error(t);
  }
  return res.json?.() ?? res;
}

async function addCredit(){
  const customer = document.getElementById("credit-customer").value.trim();
  const amount = document.getElementById("credit-amount").value;
  const description = document.getElementById("credit-desc").value;
  if(!customer || !amount){ alert("fill fields"); return; }
  await api("/api/add_credit", {method:"POST", headers:{"content-type":"application/json"}, body:JSON.stringify({customer, amount, description})});
  // alert("Credit added");
    // CLEAR FIELDS
  document.getElementById("credit-customer").value = "";
  document.getElementById("pay-customer").value = "";
  document.getElementById("purchase-customer").value = "";

  document.getElementById("credit-amount").value = "";
  document.getElementById("credit-desc").value = "";

  loadRecords(true);
}

async function addPayment(){
  const customer = document.getElementById("pay-customer").value.trim();
  const amount = document.getElementById("pay-amount").value;
  const description = document.getElementById("pay-desc").value;
  if(!customer || !amount){ alert("fill fields"); return; }
  await api("/api/add_payment", {method:"POST", headers:{"content-type":"application/json"}, body:JSON.stringify({customer, amount, description})});
  // alert("Payment recorded");
  // CLEAR FIELDS
  document.getElementById("credit-customer").value = "";
  document.getElementById("purchase-customer").value = "";
  document.getElementById("pay-customer").value = "";
  document.getElementById("pay-amount").value = "";
  document.getElementById("pay-desc").value = "";

  loadRecords(true);
}

async function addPurchase(){
  const customer = document.getElementById("purchase-customer").value.trim();
  const items = document.getElementById("purchase-items").value.trim();
  const amount = document.getElementById("purchase-amount").value;
  if(!customer || !items || !amount){ alert("fill fields"); return; }
  await api("/api/add_purchase", {method:"POST", headers:{"content-type":"application/json"}, body:JSON.stringify({customer, items, amount})});
  // alert("Purchase added");

  // CLEAR FIELDS
  document.getElementById("purchase-customer").value = "";
  document.getElementById("credit-customer").value = "";
  document.getElementById("purchase-customer").value = "";
  document.getElementById("purchase-items").value = "";
  document.getElementById("purchase-amount").value = "";

}

function openDailyReport() {
    window.location.href = "/daily-report";
}

function showPurchases() {
    const { protocol, host } = window.location; // host includes hostname:port
    const url = `${protocol}//${host}/purchases`;
    window.open(url, "_blank");
}

function clearRecordsTable() {
    const tbody = document.querySelector("#records-table tbody");
    if (tbody) tbody.innerHTML = "";
}

function makeRowEditable(tr) {
  const cells = tr.querySelectorAll("td[data-field]");
  cells.forEach(td => {
    const field = td.dataset.field;
    if (["ID","Date","Time","Balance","Owner"].includes(field)) return; // skip read-only fields

    const input = document.createElement("input");
    input.value = td.textContent;
    input.style.width = "100%";
    td.textContent = "";
    td.appendChild(input);
  });

  // Replace Edit button with Save & Cancel
  const actionTd = tr.querySelector("td:last-child");
  actionTd.innerHTML = "";

  const saveBtn = document.createElement("button");
  saveBtn.textContent = "Save";
  saveBtn.className = "btn";
  saveBtn.onclick = () => saveRecord(tr);

  const cancelBtn = document.createElement("button");
  cancelBtn.textContent = "Cancel";
  cancelBtn.className = "btn";
  cancelBtn.onclick = () => loadRecords(true); // reload to cancel edit

  actionTd.appendChild(saveBtn);
  actionTd.appendChild(cancelBtn);
}

async function filterRecords(customer){
    const data = await api("/api/credits");
    const rows = data.records.filter(r => r.Customer === customer);
    const tbody = document.querySelector("#records-table tbody");
    tbody.innerHTML = "";

    const isAdmin = "{{ role }}" === "admin"; // or get role dynamically if you have it in JS

    rows.forEach(r => {
        const tr = document.createElement("tr");

        ["ID","Date","Time","Customer","Description","Credit","Payment","Balance","Owner"].forEach(k=>{
            const td = document.createElement("td");
            td.textContent = r[k] ?? "";
            td.dataset.field = k;
            td.dataset.id = r.ID;
            tr.appendChild(td);
        });

        // Actions column
        if (isAdmin) {
            const actionTd = document.createElement("td");

            const editBtn = document.createElement("button");
            editBtn.textContent = "Edit";
            editBtn.className = "btn";
            editBtn.onclick = () => makeRowEditable(tr);

            const deleteBtn = document.createElement("button");
            deleteBtn.textContent = "Delete";
            deleteBtn.className = "btn";
            deleteBtn.onclick = () => deleteRecord(r.ID);

            actionTd.appendChild(editBtn);
            actionTd.appendChild(deleteBtn);
            tr.appendChild(actionTd);
        }

        tbody.appendChild(tr);
    });
}

async function editRecord(id){
  const newDesc = prompt("Enter new description:");
  if(newDesc === null) return;  // user canceled
  await api("/api/edit_record/" + id, {
    method: "PUT",
    headers: { "content-type": "application/json" },
    body: JSON.stringify({ Description: newDesc })
  });
  loadRecords(true);
}

async function loadRecords(showAll=false) {
  const term = document.getElementById("search-term").value.trim();
  const data = await api("/api/credits");
  let rows = data.records;
  if (!showAll && term) {
    rows = rows.filter(r => r.Customer && r.Customer.toLowerCase().includes(term.toLowerCase()));
  }

  const tbody = document.querySelector("#records-table tbody");
  tbody.innerHTML = "";

  rows.forEach(r => {
    const tr = document.createElement("tr");
    ["ID","Date","Time","Customer","Description","Credit","Payment","Balance","Owner"].forEach(k=>{
      const td = document.createElement("td");
      td.textContent = r[k] ?? "";
      td.dataset.field = k;          // store field name for editing
      td.dataset.id = r.ID;           // store record ID
      tr.appendChild(td);
    });

    // Actions column
    const actionTd = document.createElement("td");

    const editBtn = document.createElement("button");
    editBtn.textContent = "Edit";
    editBtn.className = "btn";
    editBtn.onclick = () => makeRowEditable(tr);

    const deleteBtn = document.createElement("button");
    deleteBtn.textContent = "Delete";
    deleteBtn.className = "btn";
    deleteBtn.onclick = () => deleteRecord(r.ID);

    actionTd.appendChild(editBtn);
    actionTd.appendChild(deleteBtn);
    tr.appendChild(actionTd);

    tbody.appendChild(tr);
  });
}
async function saveRecord(tr) {
  const id = tr.querySelector("td[data-field='ID']").textContent;
  const updated = {};
  
  tr.querySelectorAll("td[data-field]").forEach(td => {
    const input = td.querySelector("input");
    if (input) updated[td.dataset.field] = input.value;
  });

  if (Object.keys(updated).length === 0) return;

  await api(`/api/edit_credit/${id}`, {
    method: "POST",
    headers: {"content-type": "application/json"},
    body: JSON.stringify(updated)
  });

  loadRecords(true); // reload table after save
}
// <--------- Filter customer list -------- >
async function filterCustomerList() {
    const term = document.getElementById("cust-filter").value.trim().toLowerCase();
    const ul = document.getElementById("customers");
    ul.innerHTML = "";

    if (!term) return; // if input is empty, hide the list

    const data = await api("/api/customers");

    const matched = data.customers.filter(c => c.toLowerCase().includes(term));
    
    matched.forEach(c => {
        const li = document.createElement("li");
        li.style.padding = "6px";
        li.style.cursor = "pointer";
        li.textContent = c;
        li.onclick = () => {
            document.getElementById("credit-customer").value = c;
            document.getElementById("pay-customer").value = c;
            document.getElementById("purchase-customer").value = c;
            filterRecords(c);
            ul.innerHTML = ""; // hide the list after selection
        };
        ul.appendChild(li);
    });
}

async function onTypingCustomer(e) {
    let typed = e.target.value.trim().toLowerCase();
    if (!typed) return;

    // Get customer list from backend
    const data = await api("/api/customers");
    const customers = data.customers.map(c => c.toLowerCase());

    // If new customer typed ‚Üí clear table
    if (!customers.includes(typed)) {
        clearRecordsTable();
    }
}

async function deleteRecord(id) {
  if (!confirm("Delete this record?")) return;
  await api(`/api/delete_record/${id}`, { method: "DELETE" });
  loadRecords(true);
}
async function downloadCSV(){
  const res = await fetch("/api/download/credits");
  if(!res.ok){ alert("download failed"); return; }
  const txt = await res.text();
  const blob = new Blob([txt], {type:"text/csv"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = "credits_export.csv"; a.click();
  URL.revokeObjectURL(url);
}

async function loadUsers() {
    const ul = document.getElementById("user-list");

    // If list is already visible, hide it
    if (ul.innerHTML.trim() !== "") {
        ul.innerHTML = "";
        return;
    }

    // Otherwise, fetch and display users
    const res = await fetch("/api/users", {
        credentials: "include"  // send session cookie
    });

    if (!res.ok) {
        const text = await res.text();
        alert("Error loading users: " + res.status + "\n" + text);
        return;
    }

    const data = await res.json();
    ul.innerHTML = "";

    data.users.forEach(u => {
        const li = document.createElement("li");
        li.style.padding = "6px";

        li.innerHTML = `
            ${u.username} (${u.role})
            <button onclick="deleteUser('${u.username}')" style="background:#d9534f;color:white;margin-left:10px">Delete</button>
        `;

        ul.appendChild(li);
    });
}

async function deleteUser(username) {
    if (!confirm("Delete user '" + username + "'?")) return;

    let res = await fetch("/api/delete_user/" + username, { 
        method: "DELETE",
        credentials: "include"
    });

    let data = await res.json();   // <-- read API response

    if (!res.ok) {
        alert("Error: " + (data.detail || data.message || "Unknown error"));
        return;
    }

    alert(data.message);  // <-- show actual message from API
    loadUsers();
}

document.getElementById("credit-customer").addEventListener("input", onTypingCustomer);
document.getElementById("pay-customer").addEventListener("input", onTypingCustomer);
document.getElementById("purchase-customer").addEventListener("input", onTypingCustomer);
document.getElementById("cust-filter").addEventListener("input", filterCustomerList);

window.addEventListener("load", ()=>{ loadRecords(true); });
</script>

</body>
</html>
